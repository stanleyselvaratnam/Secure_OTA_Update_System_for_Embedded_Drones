# ==============================================================================
# Project : Secure Embedded Linux OTA System (REGA)
# File    : kas_imx8mp.yml
# Author  : Stanley Selvaratnam
# Target  : Toradex Verdin iMX8MP
# Yocto   : Scarthgap (7.x)
# Email   : stanley.selvaratnam@gmail.com
# ! Build command: KAS_BUILD_DIR=build-imx8mp kas build kas_imx8mp.yml
# ==============================================================================


header:
  version: 11

# Repository definitions and layers to enable
repos:
  poky:
    url: "https://git.yoctoproject.org/poky.git"
    refspec: "scarthgap"
    layers:
      meta:
      meta-poky:
      meta-yocto-bsp:

  meta-openembedded:
    url: "https://git.openembedded.org/meta-openembedded"
    refspec: "scarthgap"
    layers:
      meta-oe:
      meta-networking:
      meta-python:
      meta-multimedia:
      meta-gnome:
      meta-filesystems:
      meta-perl:

  meta-qt5:
    url: "https://github.com/meta-qt5/meta-qt5.git"
    refspec: "scarthgap"
  
  meta-lts-mixins-uboot:
    url: https://git.yoctoproject.org/meta-lts-mixins
    refspec: "scarthgap/u-boot"
    path: "meta-lts-mixins"
  
  meta-arm:
    url: "git://git.yoctoproject.org/meta-arm"
    refspec: "scarthgap"
    layers:
      meta-arm:
      meta-arm-toolchain:
      meta-arm-bsp:

  meta-ti:
    url: "git://git.yoctoproject.org/meta-ti"
    refspec: "scarthgap"
    layers:
      meta-ti-bsp:
      meta-ti-extras:

  meta-security:
    url: "git://git.yoctoproject.org/meta-security"
    refspec: "scarthgap"
    layers:
      meta-tpm:
      .:

  meta-freescale-distro:
    url: "https://github.com/Freescale/meta-freescale-distro.git"
    refspec: "scarthgap"


  meta-freescale:
    url: "https://github.com/Freescale/meta-freescale.git"
    refspec: "scarthgap"

  meta-freescale-3rdparty:
      url: "https://github.com/Freescale/meta-freescale-3rdparty.git"
      refspec: "scarthgap"

  meta-toradex-bsp-common:
    url: "https://git.toradex.com/meta-toradex-bsp-common.git"
    refspec: "scarthgap-7.x.y"

  meta-toradex-nxp:
    url: "https://git.toradex.com/meta-toradex-nxp.git"
    refspec: "scarthgap-7.x.y"
  
  meta-toradex-distro:
    url: "https://git.toradex.com/meta-toradex-distro.git"
    refspec: "scarthgap-7.x.y"

  meta-toradex-demos:
    url: "https://git.toradex.com/cgit/meta-toradex-demos.git/"
    refspec: "scarthgap-7.x.y"

  meta-toradex-security:
    url: "https://github.com/toradex/meta-toradex-security.git"
    refspec: "scarthgap-7.x.y"

  meta-toradex-ti:
    url: "git://git.toradex.com/meta-toradex-ti"
    refspec: "scarthgap-7.x.y"

  # meta-toradex-tezi:
  #   url: "https://github.com/toradex/meta-toradex-tezi.git"
  #   refspec: "scarthgap-7.x.y"

  
  meta-mender:
    url: "https://github.com/mendersoftware/meta-mender.git"
    refspec: "scarthgap"
    #commit: "bff4b64715aae33e5c3a0bf5c804e6a1f4726c1c"
    layers:
      meta-mender-core:
      
  # Test custom layer integration from github
  # meta-custom:
  #   url: "https://github.com/stanleyselvaratnam/meta-custom.git"
  #   refspec: "main"
  #   layers:
  #     meta-key:

  meta-imx8mp-rega:
    path: "meta-imx8mp-rega"
    layers:
      meta-mender-toradex-nxp:
      meta-wic:
      meta-local:
      meta-connectivity:
      meta-key:
      meta-custom-u-boot:
      meta-mender-imx:
      meta-imx-firmware:
      meta-crypto:
      meta-example:
      # meta-rollback:
      meta-custom-security:

build_system: oe

target:
  - tdx-reference-minimal-image

machine: verdin-imx8mp

distro: tdx-xwayland

env:
  SSTATE_DIR: "/workdir/build-sstate-${MACHINE}"

local_conf_header:
  my-config: |

    # ================================================================
    # General Build Configuration
    # ================================================================

    INHERIT += "rm_work"
    PACKAGE_CLASSES ?= "package_ipk"
    INIT_MANAGER = "systemd"
    IMAGE_FSTYPES += "ext4"
    ACCEPT_FSL_EULA = "1"


    EXTRA_IMAGE_FEATURES = "debug-tweaks"
    IMAGE_INSTALL:remove = "packagegroup-basic"
    IMAGE_INSTALL:append = " packagegroup-core-ssh-openssh openssh-sftp-server vim nano"
    DISTRO_FEATURES:remove = "ssh-server-dropbear"
    IMAGE_INSTALL:remove = "dropbear"
    

    
    # * ================================================================
    # * Partition with WKS (meta-wic)
    # * ================================================================

    IMAGE_FSTYPES += "wic"
    WKS_FILE = "imx8mp-custom"

    # * ================================================================
    # * Mender OTA Configuration (meta-mender-core)
    # * ================================================================

    INHERIT += "mender-full"
    TORADEX_BSP_VERSION = "toradex-bsp-7.1.0"
  
    # Use Mender-specific U-Boot providers
    PREFERRED_PROVIDER_u-boot = "u-boot-mender"
    PREFERRED_PROVIDER_u-boot-fw-utils = "u-boot-fw-utils-mender"

    # Name of the Mender artifact
    MENDER_ARTIFACT_NAME = "release-with-secure-boot"

    # # Mender server URL and tenant token
    # MENDER_SERVER_URL = "https://eu.hosted.mender.io"
    # MENDER_SERVER_URL = ""
    # MENDER_TENANT_TOKEN = "AVi5j0YkJYNeYRamqwzY2r9WRz3sJo5nbGDGaE0uXtQ"

    # Polling intervals (empty = default)
    MENDER_UPDATE_POLL_INTERVAL_SECONDS = ""
    MENDER_INVENTORY_POLL_INTERVAL_SECONDS = ""
    MENDER_RETRY_POLL_INTERVAL_SECONDS = ""

    # Mender partition definitions (A/B rootfs scheme)
    MENDER_BOOT_PART = "${MENDER_STORAGE_DEVICE_BASE}1"
    MENDER_DATA_PART = "${MENDER_STORAGE_DEVICE_BASE}4"
    MENDER_ROOTFS_PART_A = "${MENDER_STORAGE_DEVICE_BASE}2"
    MENDER_ROOTFS_PART_B = "${MENDER_STORAGE_DEVICE_BASE}3"

    # Device type compatible with Mender server
    MENDER_DEVICE_TYPE = "imx8mp-verdin"

    # Storage device and partition layout
    MENDER_STORAGE_DEVICE = "/dev/mmcblk1"
    MENDER_STORAGE_TOTAL_SIZE_MB = "4096"
    MENDER_BOOT_PART_SIZE_MB = "100"
    MENDER_DATA_PART_SIZE_MB = "512"
    MENDER_FEATURES_ENABLE:append = " mender-image-gpt mender-uboot"
    MENDER_FEATURES_DISABLE:append = " mender-grub mender-image-uefi"

    # ! Enable automatic U-Boot configuration for partitions
    MENDER_UBOOT_AUTO_CONFIGURE = "1"

    # --- MENDER SIGNING / VERIFY CONFIGURATION ---

    # Install public keys provided by mender-keys.bb
    IMAGE_INSTALL:append = " mender-keys mender-keys-rotation"

    # Private key path for signing artifacts (absolute path required)
    MENDER_ARTIFACT_SIGNING_KEY = "${TOPDIR}/../mender-keys/private.key"

    # Public key for build-time artifact verification (optional)
    # MENDER_ARTIFACT_VERIFY_KEY  = "${TOPDIR}/../mender-keys/public.key"

   
    IMAGE_INSTALL:append = " mender-artifact-info"

    # TLS and network tools for Mender integration
    IMAGE_INSTALL:append = " mender-cert"
    IMAGE_INSTALL:append = " wget"
    IMAGE_INSTALL:append = " tcpdump"
    # Recipes to add state script with tool
    IMAGE_INSTALL:append = " state-scripts"
    IMAGE_INSTALL:append = " curl"

    # * ================================================================
    # * U-Boot Specific Configuration for SD Chain
    # * ================================================================

    # Forcer l'environnement sur SD
    BOOTENV_SIZE = "0x4000"
    UBOOT_ENV_SIZE = "0x4000"

    # MENDER_UBOOT_STORAGE_DEVICE = "1"
    # MENDER_UBOOT_ENV_STORAGE_DEVICE_OFFSET_1 = "0x800000"
    # MENDER_UBOOT_ENV_STORAGE_DEVICE_OFFSET_2 = "0x1000000"


    # * ================================================================
    # * Custom U-Boot Boot Files
    # * ================================================================

    # Clean the boot partition with only the necessary files   
    IMAGE_BOOT_FILES:remove = "overlays overlays.txt overlays/*;overlays/"

    # Custom boot files for Verdin iMX8MP
    IMAGE_BOOT_FILES = " \
        boot-loader.scr \
        boot.scr-verdin-imx8mp;my_custom_boot.scr \
        u-boot-verdin-imx8mp.bin \
    "
    IMAGE_INSTALL:append = " device-tree-overlays-rootfs"

    # * ================================================================
    # * ENABLE SSH
    # * ================================================================

    # Extra image features: debugging tools and SSH server
    EXTRA_IMAGE_FEATURES ?= "ssh-server-openssh"
    IMAGE_INSTALL:append = " ssh-keys"

    # Set root password to 'password123' (change in production)
    INHERIT += "extrausers"
    EXTRA_USERS_PARAMS = "usermod -p '$(openssl passwd -1 password123)' root;"

    # * ================================================================
    # * STATIC HOST MAPPING
    # * ================================================================
    
    # IMAGE_INSTALL:append = " hosts"

    # ! ================================================================
    # ! ENCRYPTED PARTITION SETUP
    # ! ================================================================
    #  Disable automatic /data mount by Mender
    MENDER_DATA_MOUNT_DISABLED = "1"

    # Explicitly set /data to partition 4
    MENDER_DATA_PART = "${MENDER_STORAGE_DEVICE_BASE}4"
    
    # Enable GPT partitioning
    MENDER_FEATURES_ENABLE:append = " mender-image-gpt"
    
    # Add secure data partition (unformatted, 256MB)
    MENDER_EXTRA_PARTS = "securepart"
    MENDER_EXTRA_PARTS[securepart] = "--label=securedata --size=256"
    
    # Install LUKS tools and init script
    # IMAGE_INSTALL:append = " cryptsetup e2fsprogs util-linux lsof luks-init"
    
    # Enable systemd (required for encryption services)
    SYSTEMD_AUTO_ENABLE:pn-systemd = "enable"

    # Optional: Auto fstab options (commented)
    # MENDER_EXTRA_PARTS_FSTAB[securepart] = "auto defaults 0 2"

    # Optional: Symlinks to put files in secure partition
    # IMAGE_INSTALL:append = " secure-symlinks"


    # ! ================================================================
    # ! Rollback
    # ! ================================================================

    # IMAGE_INSTALL:append = " remove-kernel-rootfs"

    # * ================================================================
    # * Security Features (Toradex meta-toradex-security)
    # * ================================================================
    BBMASK += "meta-toradex-security/dynamic-layers/toradex-bsp-common/recipes-bsp/u-boot/u-boot-distro-boot.bbappend"
    
    # --- CVE CHECK ---
    # Enable VEX (Vendor Extension) support
    INHERIT += "vex"

    # --- FULL ROOTFS READ-ONLY ---
    IMAGE_FEATURES += "read-only-rootfs"

    # --- ENCRYPTED PARTITION CAAM ---
    # Enable encrypted rootfs and OP-TEE
    INHERIT += "tdx-encrypted tdx-optee"

    # Use CAAM (Cryptographic Acceleration and Assurance Module)
    TDX_ENC_KEY_BACKEND:forcevariable = "caam"
    TDX_ENC_KEY_LOCATION = "filesystem"
    TDX_ENC_KEY_DIR = "/data/caam"
    TDX_ENC_KEY_FILE = "securedata-key.blob"

    # Encrypted partition mapping
    TDX_ENC_STORAGE_LOCATION = "/dev/mmcblk1p5"
    TDX_ENC_MAPPER_NAME = "securedata"
    TDX_ENC_STORAGE_MOUNTPOINT = "/securedata" 

    # --- TEE and fTPM ---
    # Force OP-TEE tests and fTPM (Firmware TPM)
    TDX_OPTEE_INSTALL_TESTS = "1"
    TDX_OPTEE_FTPM = "1"

    # Required distro features for security
    DISTRO_FEATURES:append = " optee tee dm-verity tpm"
    DISTRO_FEATURES:append = " security"

    # --- SECURE BOOT and UBOOT HARDENING---
    # HAB/secure boot enable
    INHERIT += "tdx-signed"
    TDX_IMX_HAB_ENABLE = "1"
    TDX_IMX_HAB_CST_DIR = "${TOPDIR}/../IMX_CST_TOOL_NEW/cst-4.0.1"
    TDX_IMX_HAB_CST_CRYPTO = "rsa"
    TDX_IMX_HAB_CST_KEY_SIZE = "2048"
    TDX_IMX_HAB_CST_DIG_ALGO = "sha256"
    TDX_IMX_HAB_CST_SRK_INDEX = "1"


    # U-Boot Hardening
    TDX_UBOOT_HARDENING_ENABLE  = "1"
    TDX_UBOOT_HARDENING_ENABLE_DBG = "1"

    # * ================================================================
    # * Toradex Easy Installer
    # * ================================================================
    # INHERIT += "toradex-mirrors"
    # BBMASK += "/meta-freescale/recipes-bsp/alsa-state"

    # # Configurez explicitement le noyau préféré
    # PREFERRED_PROVIDER_virtual/kernel = "linux-toradex"

    # # UBOOT_MACHINE pour config u-boot
    # # UBOOT_MACHINE = "verdin-imx8mp"
    # UBOOT_CONFIG_BASENAME = "verdin-imx8mp"
    # # CORE_IMAGE_EXTRA_INSTALL += "firmware-imx"

    # # IMAGE_BOOT_FILES:remove = "boot.scr-${MACHINE};boot.scr"
    # # IMAGE_BOOT_FILES:append = " boot.scr-${MACHINE}-1.1-r0;boot.scr"

    # IMAGE_BOOT_FILES:remove = "boot.scr-${MACHINE};boot.scr"
    # IMAGE_BOOT_FILES:append = " boot.scr"
    # MENDER_IMAGE_BOOTLOADER_BOOTSECTOR_OFFSET = "0"

    # INHERIT += "mender-toradex"
    # IMAGE_CLASSES += "image_type_mender_tezi"
    # IMAGE_FSTYPES:append = " mender_tezi"
    # # IMAGE_FSTYPES:remove = " teziimg"
    # IMAGE_FSTYPES:remove = " tezirunimg"

    # # IMAGE_CLASSES:remove = "image_type_tezi"
    # # IMAGE_FSTYPES:remove = "tezi teziimg"

    # ? ================================================================
    # ? Build performance tuning
    # ? ================================================================

    # Limit the number of parallel tasks to avoid memory issues
    BB_NUMBER_THREADS = "10"
    PARALLEL_MAKE = "-j 10"