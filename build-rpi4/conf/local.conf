# my-config

# TODO : test the rollback, partition the kernel, double authentification
# * ================================================================
# * Local configuration for building core-image-minimal with Mender
# * ================================================================

# Inherit the full Mender integration layer
INHERIT += "mender-full"
# This really saves a lot of disk space!
INHERIT += "rm_work"
# * ================================================================
# * Package management and image features
# * ================================================================

# Use IPK as package format
PACKAGE_CLASSES ?= "package_ipk"

# Extra image features: debugging tools and SSH server
EXTRA_IMAGE_FEATURES ?= "debug-tweaks ssh-server-openssh"

# Packages to include in the image
IMAGE_INSTALL:append = " htop vim ca-certificates helloworld hellocustom"

# * ================================================================
# * Bootloader configuration
# * ================================================================

# U-Boot bootloader files to include in image
# ! UBOOT_MACHINE = "qemu_arm64_defconfig"
UBOOT_MACHINE = "raspberrypi4_64_defconfig"

IMAGE_BOOT_FILES = "u-boot.bin"

# Init system to use
INIT_MANAGER = "systemd"

# # Kernel et DTB
# KERNEL_DEVICETREE = "qemu.dtb"

# UBOOT_CONFIGURE_ARGS:append = " --disable-efi"

# # Install files in /boot pour U-Boot
# IMAGE_INSTALL:append = " kernel-image kernel-devicetree"

# # Disable EFI-related packages if any
# # IMAGE_INSTALL:remove = "efi-utils"

# * ================================================================
# * ENABLE UART
# * ================================================================

ENABLE_UART = "1"

# * ================================================================
# * Image types
# * ================================================================

# Build SD card image
IMAGE_FSTYPES += "sdimg"

# * ================================================================
# * Partition with WKS (meta-wic)
# * ================================================================

# ! WIC image configuration
# WKS_FILE = "custom-qemuarm64.wks.in"
# IMAGE_FSTYPES += "wic wic.bz2"

# * ================================================================
# * Mender configuration (meta-mender-core)
# * ================================================================

# Name of the Mender artifact
MENDER_ARTIFACT_NAME = "release-7"

# Mender server URL and tenant token
MENDER_SERVER_URL = "https://eu.hosted.mender.io"
MENDER_TENANT_TOKEN = "AVi5j0YkJYNeYRamqwzY2r9WRz3sJo5nbGDGaE0uXtQ"

# Device type
# ! MENDER_DEVICE_TYPE = "qemuarm64"
MENDER_DEVICE_TYPE = "raspberrypi4-64"

# Storage device and partition layout
# ! MENDER_STORAGE_DEVICE = "/dev/vda"
MENDER_STORAGE_DEVICE = "/dev/mmcblk0"
MENDER_STORAGE_TOTAL_SIZE_MB = "4096"
MENDER_BOOT_PART_SIZE_MB = "16"
MENDER_DATA_PART_SIZE_MB = "128"

# ! Enable automatic U-Boot configuration for partitions
MENDER_UBOOT_AUTO_CONFIGURE = "0"

# Polling intervals (empty = default)
MENDER_UPDATE_POLL_INTERVAL_SECONDS = ""
MENDER_INVENTORY_POLL_INTERVAL_SECONDS = ""
MENDER_RETRY_POLL_INTERVAL_SECONDS = ""

# --- MENDER SIGNING / VERIFY CONFIGURATION ---

# Clé publique installée par mender-keys.bb
IMAGE_INSTALL:append = " mender-keys mender-keys-rotation"

# Clé privée utilisée pour signer les artifacts (chemin absolu)
MENDER_ARTIFACT_SIGNING_KEY = "${TOPDIR}/../mender-keys/private.key"

# Clé publique utilisée pour vérifier les artifacts pendant le build
# MENDER_ARTIFACT_VERIFY_KEY  = "${TOPDIR}/../mender-keys/public.key"


IMAGE_INSTALL:append = " mender-artifact-info"
# ! ================================================================
# ! Test Rollback (meta-rollback)
# ! ================================================================

# ! Only to test the rollback
# ! IMAGE_INSTALL:append = " rollback-test"

# ? ================================================================
# ? Build performance tuning
# ? ================================================================

# Limit the number of parallel tasks to avoid memory issues
BB_NUMBER_THREADS = "10"
PARALLEL_MAKE = "-j 10"

# ? ================================================================
# ? Experimental / commented options
# ? ================================================================

# Uncomment to include Mender packages (if using RPM or testing)
# IMAGE_INSTALL:append = " mender-client mender-auth mender-update"

# BBMASK examples (to exclude certain recipes)
# BBMASK += "recipes-mender/mender-client/mender-client_3.5.3.bb"
# BBMASK += "recipes-mender/mender-client/mender-client_git.bb"
# Force specific Mender version or provider
# PREFERRED_VERSION_mender-client = "5.0.2"
# PREFERRED_VERSION_mender = "5.0.2"
# PREFERRED_PROVIDER_mender = "mender"

# Debug prefix map removal
# DEBUG_PREFIX_MAP:remove = "-fcanon-prefix-map"

# Kernel device tree configuration
# KERNEL_DEVICETREE = "qemu.dtb"

# Bootloader and kernel preferences
# IMAGE_INSTALL:remove = "grub"
# UBOOT_MACHINE = "qemu_arm64_defconfig"
# IMAGE_CLASSES = ""
# PREFERRED_PROVIDER_virtual/bootloader = "u-boot"
# PREFERRED_PROVIDER_virtual/kernel = "linux-yocto"

# Emulator / RTC tools
# IMAGE_INSTALL:append = " rtc-tools"

MACHINE ??= "raspberrypi4-64"
DISTRO ??= "poky"
BBMULTICONFIG ?= ""
