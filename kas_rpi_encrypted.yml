# ! KAS_BUILD_DIR=build-rpi4-encrypted kas build kas_rpi_encrypted.yml

header:
  version: 11

repos:
  poky:
    url: "https://git.yoctoproject.org/poky.git"
    refspec: "scarthgap"
    layers:
      meta:
      meta-poky:
      meta-yocto-bsp:

  meta-openembedded:
    url: "https://git.openembedded.org/meta-openembedded"
    refspec: "scarthgap"
    layers:
      meta-oe:
      meta-networking:
      meta-python:

  meta-mender:
    url: "https://github.com/mendersoftware/meta-mender.git"
    refspec: "scarthgap"
    layers:
      meta-mender-core:

  # meta-mender-community:
  #   url: "https://github.com/mendersoftware/meta-mender-community.git"
  #   refspec: "scarthgap"
  #   layers:
  #     meta-mender-raspberrypi:

  meta-raspberrypi:
    url: "https://github.com/agherzan/meta-raspberrypi.git"
    refspec: 1091bde25e9ebaea33114edb85e4aee931d105f3

  bitbake-variable-substitution:
    url: "https://github.com/coreycothrum/meta-bitbake-variable-substitution.git"
    refspec: "master"

  meta-mender-kernel:
    url: "https://github.com/coreycothrum/meta-mender-kernel.git"
    refspec: "scarthgap"

  meta-custom:
    url: "https://github.com/stanleyselvaratnam/meta-custom.git"
    refspec: "main"
    layers:
      meta-hellocustom:
      meta-key:
      
  meta-my-layer:
    path: "meta-my-layer"
    layers:
      meta-connectivity:
      meta-kernel:

build_system: oe

target:
  - core-image-base

machine: raspberrypi4-64
distro: poky

env:
  SSTATE_DIR: "/workdir/build-sstate-${MACHINE}"

local_conf_header:
  my-config: |
    INHERIT += "mender-full rm_work"

    # Désactiver le déploiement du kernel Mender (inutile sans U-Boot)
    MENDER_FEATURES_DISABLE:append = " mender-kernel"
    # MENDER_FEATURES_ENABLE = "mender-image mender-systemd mender-uboot"

    IMAGE_FSTYPES = "sdimg"
    INIT_MANAGER = "systemd"
    PACKAGE_CLASSES ?= "package_ipk"
    IMAGE_INSTALL:append = " htop vim ca-certificates"

    EXTRA_IMAGE_FEATURES ?= "ssh-server-openssh"
    IMAGE_INSTALL:append = " ssh-keys"

    INHERIT += "extrausers"
    EXTRA_USERS_PARAMS = "usermod -p '$(openssl passwd -1 password123)' root;"

    KERNEL_DEVICETREE = "broadcom/bcm2711-rpi-4-b.dtb"

    ENABLE_UART = "1"
    RPI_EXTRA_CONFIG += "dtoverlay=disable-bt"

    DISTRO_FEATURES:append = " wifi"
    LICENSE_FLAGS_ACCEPTED += "synaptics-killswitch"
    # ! require conf/include/mender-kernel-setup.inc 
    # ! IMAGE_INSTALL:append = " mender-keys mender-keys-rotation mender-artifact-info hosts"
    # Mender configuration
    MENDER_ARTIFACT_NAME = "release-2"
    MENDER_DEVICE_TYPE = "raspberrypi4-64"
    MENDER_STORAGE_DEVICE = "/dev/mmcblk0"
    MENDER_STORAGE_TOTAL_SIZE_MB = "4096"
    MENDER_BOOT_PART_SIZE_MB = "256"
